# ECS160-HW3

## Due date: 12/12/2025 (last day of the quarter)
Note: no late days will be permitted on this homework

## Problem: Using AFL++ for fuzzing LibPNG library

## Points: 15 points (+5 for EC)

_Learning objectives:_
1. Writing a test harness for a library.
3. Compiling the library and harness with the Fuzzer instrumentation.
3. Compiling the library and harness with the Sanitizer + Fuzzer instrumentation.
5. Writing a custom mutator (Extra Credit)

_Necessary background knowledge:_
1. Fuzzers
2. Sanitizers

_Problem Statement:_
We learned about fuzzers and sanitizers in class. In this homework, we will evaluate the effectiveness of fuzzers in finding bugs in the [LibPNG](https://github.com/pnggroup/libpng) codebase. 

### Submission instructions
Please submit the following items:
1. Your test harness code.
2. A script to automate the generation of the fuzzing targets.
   1) clones or downloads the LibPNG source code
   2) clones and build AFL++.
   3) compiles it with each of the configurations described in Part B, C, and D (EC).
3. An `ANALYSIS.md` file that describes the results of the experiments described in Part B, C, and D (EC). Please mention the specs of the machine you ran your experiment on (CPU, memory, etc). You can run each configuration on a different machine - in that case, describe the specs of each machine for each configuration.

### Part A: Writing the test harness

Because this is a library and does not have a `main` function, we have to first write a test harness that accepts a file as an input and invokes the PNG API functions, specified in `png.h` for testing. A rough skeleton of this file could be something like ---

```
#include <png.h>
#include <stdio.h>
#include <stdlib.h>

int main(int argc, char **argv) {
    if (argc < 2) return 0;
    FILE *fp = fopen(argv[1], "rb");
    if (!fp) return 0;

    png_structp png = png_create_read_struct(PNG_LIBPNG_VER_STRING, NULL, NULL, NULL);
    if (!png) { fclose(fp); return 0; }

    png_infop info = png_create_info_struct(png);
    if (!info) {
        fclose(fp);
        png_destroy_read_struct(&png, NULL, NULL);
        return 0;
    }

    // ... Test other functions
    return 0;
}

```

### Part B: Running the application with the AFL++ fuzzer

1. First, compile AFL++ according to the instructions [here](https://github.com/AFLplusplus/AFLplusplus/blob/stable/docs/INSTALL.md). 
2. Compile both the library and the harness with the `afl-cc` and the `afl-c++` compilers generated in the previous step.
3. Fuzz the generated binary for 3 hours **without any seeds.**
   1) Report the number of crashes found, the coverage, and the execution throughput. 
5. Download 10 sample PNG files from the internet. Fuzz the generated binary for 1 hour **with these files as seeds.**
   1) Report the number of crashes found, the coverage, and the execution throughput.
  
### Part C: Running the application with the AFL++ fuzzer and the ASAN and UBSAN sanitizers enabled. 
1. Recompile the LibPNG library and the test harness with the ASAN and UBSAN sanitizers.
2. Fuzz the generated by for 1 hour with the 10 sample PNG files downloaded in Part B as seeds.
3. Report the number of crashes found, the coverage, and the execution throughput.

### Part D: Write a custom mutator for LibPNG (Extra-Credit)
AFL++ allows the user to write custom mutators for the fuzzing target being fuzzed. This allows the user to add custom mutation logic specific to the target being fuzzed. Check [here](https://aflplus.plus/docs/custom_mutators/) for the documentation. You can look up the PNG specification on [Wikipedia](https://en.wikipedia.org/wiki/PNG) or read the original specification [here](https://www.libpng.org/pub/png/spec/1.2/PNG-Contents.html).
1. Write a custom mutator for the LibPNG library.
2. Fuzz the binary generated in Part C with the custom mutator for 1 hour.
3. Report the number of crashes found, the coverage, and the execution throughput.
4. Also, describe your mutation logic.

### Grading Rubric
1. Part A: 5 points
2. Part B: 5 points
3. Part C: 5 points
4. Part D: 5 points (Extra-Credit)

### AI policy (for this homework ONLY)
1. You can use AI to help with the commands in Part B, C, and D
2. You can use AI to list all the PNG API functions.
3. You can use AI to summarize the PNG specifications from Wikipedia or libpng website.
4. You cannot use AI to generate the code for the test harness in Part A.
5. You cannot use AI to generate the custom mutator logic in Part D.
6. You cannot use AI to generate the `ANALYSIS.md` file.
